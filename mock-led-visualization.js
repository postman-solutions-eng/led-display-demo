/*
  LED Display Scrolling Visualization for the Postman LED Badge

  Usage:

    1. Import your package
    const ledViz = pm.require('PACKAGE_IDENTIFIER');

    2. Construct the data payload
    const payload = {
        displayText: pm.response.json().text || "NO DATA"
    };

    3. Pass the imported template to the visualizer
    pm.visualizer.set(ledViz.template, payload);
*/
var template = `
<style>
    body { margin: 0; padding: 20px; background: #0a0a0a; font-family: Arial, sans-serif; }
    .container { max-width: 100%; margin: 0 auto; overflow: hidden; } /* Allow full width */
    
    .led-section { 
        background: linear-gradient(145deg, #2a2a2a, #1a1a1a); 
        border: 3px solid #333; 
        border-radius: 15px; 
        padding: 30px 40px; 
        margin-bottom: 30px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* SCROLLING MAGIC HAPPENS HERE */
    .led-display { 
        background: #000; 
        border: 2px solid #444; 
        border-radius: 8px; 
        padding: 15px; 
        position: relative; 
        overflow: hidden; /* Hide the text that is "off screen" */
        height: 100px; /* Fixed height to contain the grid */
    }

    .led-matrix { 
        display: inline-block; 
        background: #000; 
        padding: 0; 
        border-radius: 4px;
        position: absolute; /* Allows us to move it */
        left: 100%; /* Start completely off-screen to the right */
        /* Animation is injected via JS to control speed */
    }

    .led-row { display: flex; gap: 2px; margin-bottom: 2px; }
    .led-row:last-child { margin-bottom: 0; }
    
    .led-pixel { 
        width: 8px; 
        height: 8px; 
        border-radius: 50%; 
        background: #1a0000; 
        flex-shrink: 0; /* Prevents pixels from squishing during scroll */
    }
    
    .led-pixel.on { 
        background: #ff0000; 
        box-shadow: 0 0 4px #ff0000, 0 0 8px #ff0000; 
    }

    .info { color: #888; font-size: 12px; text-align: center; margin-top: 15px; font-family: monospace; }

    /* The Animation Definition */
    @keyframes marquee {
        0%   { transform: translateX(0); }
        100% { transform: translateX(-100%); } /* Move entirely to the left */
    }
</style>

<div class="container">
    <div class="led-section">
        <div class="led-display">
            <div class="led-matrix" id="ledMatrix"></div>
        </div>
        <div class="info">LED Simulator | Text: <span id="txt-display"></span></div>
    </div>
</div>

<script>
    // FONT LIBRARY
    const LED_FONTS = {
        ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        '!': [0x00, 0x00, 0x5F, 0x00, 0x00, 0x00, 0x00],
        '"': [0x00, 0x07, 0x00, 0x07, 0x00, 0x00, 0x00],
        '#': [0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00, 0x00],
        '$': [0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00, 0x00],
        '%': [0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00],
        '&': [0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x00],
        "'": [0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00],
        '(': [0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x00],
        ')': [0x00, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00],
        '*': [0x14, 0x08, 0x3E, 0x08, 0x14, 0x00, 0x00],
        '+': [0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00],
        ',': [0x00, 0x50, 0x30, 0x00, 0x00, 0x00, 0x00],
        '-': [0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00],
        '.': [0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00],
        '/': [0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00],
        '0': [0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00, 0x00],
        '1': [0x00, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00],
        '2': [0x42, 0x61, 0x51, 0x49, 0x46, 0x00, 0x00],
        '3': [0x21, 0x41, 0x45, 0x4B, 0x31, 0x00, 0x00],
        '4': [0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00],
        '5': [0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00],
        '6': [0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00, 0x00],
        '7': [0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00],
        '8': [0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00],
        '9': [0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x00],
        ':': [0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00],
        ';': [0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x00],
        '<': [0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00],
        '=': [0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00],
        '>': [0x00, 0x41, 0x22, 0x14, 0x08, 0x00, 0x00],
        '?': [0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00],
        '@': [0x32, 0x49, 0x79, 0x41, 0x3E, 0x00, 0x00],
        'A': [0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00, 0x00],
        'B': [0x7F, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00],
        'C': [0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00],
        'D': [0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00],
        'E': [0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00],
        'F': [0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00],
        'G': [0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00, 0x00],
        'H': [0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00],
        'I': [0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00],
        'J': [0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00],
        'K': [0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00],
        'L': [0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00],
        'M': [0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00],
        'N': [0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00, 0x00],
        'O': [0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00],
        'P': [0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00],
        'Q': [0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00, 0x00],
        'R': [0x7F, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00],
        'S': [0x46, 0x49, 0x49, 0x49, 0x31, 0x00, 0x00],
        'T': [0x01, 0x01, 0x7F, 0x01, 0x01, 0x00, 0x00],
        'U': [0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00, 0x00],
        'V': [0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00, 0x00],
        'W': [0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00, 0x00],
        'X': [0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00],
        'Y': [0x07, 0x08, 0x70, 0x08, 0x07, 0x00, 0x00],
        'Z': [0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x00],
        '[': [0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00],
        '\\\\': [0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00],
        ']': [0x00, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00],
        '^': [0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00],
        '_': [0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00],
        'a': [0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00],
        'b': [0x7F, 0x48, 0x44, 0x44, 0x38, 0x00, 0x00],
        'c': [0x38, 0x44, 0x44, 0x44, 0x20, 0x00, 0x00],
        'd': [0x38, 0x44, 0x44, 0x48, 0x7F, 0x00, 0x00],
        'e': [0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00],
        'f': [0x08, 0x7E, 0x09, 0x01, 0x02, 0x00, 0x00],
        'g': [0x0C, 0x52, 0x52, 0x52, 0x3E, 0x00, 0x00],
        'h': [0x7F, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00],
        'i': [0x00, 0x44, 0x7D, 0x40, 0x00, 0x00, 0x00],
        'j': [0x20, 0x40, 0x44, 0x3D, 0x00, 0x00, 0x00],
        'k': [0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00],
        'l': [0x00, 0x41, 0x7F, 0x40, 0x00, 0x00, 0x00],
        'm': [0x7C, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00],
        'n': [0x7C, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00],
        'o': [0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00],
        'p': [0x7C, 0x14, 0x14, 0x14, 0x08, 0x00, 0x00],
        'q': [0x08, 0x14, 0x14, 0x18, 0x7C, 0x00, 0x00],
        'r': [0x7C, 0x08, 0x04, 0x04, 0x08, 0x00, 0x00],
        's': [0x48, 0x54, 0x54, 0x54, 0x20, 0x00, 0x00],
        't': [0x04, 0x3F, 0x44, 0x40, 0x20, 0x00, 0x00],
        'u': [0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00, 0x00],
        'v': [0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00, 0x00],
        'w': [0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00, 0x00],
        'x': [0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00],
        'y': [0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00, 0x00],
        'z': [0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00],
        '{': [0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00],
        '|': [0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00],
        '}': [0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00],
        '~': [0x10, 0x08, 0x08, 0x10, 0x08, 0x00, 0x00]
    };
    
    // Helper to convert Python packed byte format to LED Matrix (11 rows)
    function createIcon(width, bytes) {
        const matrix = [];
        for (let r = 0; r < 11; r++) {
            let rowData = [];
            for (let s = 0; s < width; s++) {
                // Python data is stored in vertical strips of 11 bytes
                // Strip 0 is bytes 0-10, Strip 1 is 11-21, etc.
                const byteVal = bytes[r + (s * 11)];
                // Convert byte to 8 bits (MSB left)
                for (let b = 7; b >= 0; b--) {
                    rowData.push((byteVal >> b) & 1);
                }
            }
            matrix.push(rowData);
        }
        return matrix;
    }

    const LED_ICONS = {
        'ball': createIcon(1, [0, 0, 0x3c, 0x7e, 0xff, 0xff, 0xff, 0xff, 0x7e, 0x3c, 0]),
        'happy': createIcon(1, [0, 0, 0x3c, 0x42, 0xa5, 0x81, 0xa5, 0x99, 0x42, 0x3c, 0]),
        'happy2': createIcon(2, [0x00, 0x08, 0x14, 0x08, 0x01, 0x00, 0x00, 0x61, 0x30, 0x1c, 0x07, 0x00, 0x20, 0x50, 0x20, 0x00, 0x80, 0x80, 0x86, 0x0c, 0x38, 0xe0]),
        'heart': createIcon(1, [0x00, 0x00, 0x6c, 0x92, 0x82, 0x82, 0x44, 0x28, 0x10, 0x00, 0x00]),
        'HEART': createIcon(1, [0x00, 0x00, 0x6c, 0xfe, 0xfe, 0xfe, 0x7c, 0x38, 0x10, 0x00, 0x00]),
        'heart2': createIcon(2, [0x00, 0x0c, 0x12, 0x21, 0x20, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00, 0x60, 0x90, 0x08, 0x08, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00]),
        'HEART2': createIcon(2, [0x00, 0x0c, 0x1e, 0x3f, 0x3f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x01, 0x00, 0x60, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xe0, 0xc0, 0x80, 0x00]),
        'fablab': createIcon(2, [0x07, 0x0e, 0x1b, 0x03, 0x21, 0x2c, 0x2e, 0x26, 0x14, 0x1c, 0x06, 0x80, 0x60, 0x30, 0x80, 0x88, 0x38, 0xe8, 0xc8, 0x10, 0x30, 0xc0]),
        'bicycle': createIcon(3, [0x01, 0x02, 0x00, 0x01, 0x07, 0x09, 0x12, 0x12, 0x10, 0x08, 0x07, 0x00, 0x87, 0x81, 0x5f, 0x22, 0x94, 0x49, 0x5f, 0x49, 0x80, 0x00, 0x00, 0x80, 0x00, 0x80, 0x70, 0xc8, 0x24, 0xe4, 0x04, 0x88, 0x70]),
        'bicycle_r': createIcon(3, [0x00, 0x00, 0x00, 0x00, 0x07, 0x09, 0x12, 0x13, 0x10, 0x08, 0x07, 0x00, 0xf0, 0x40, 0xfd, 0x22, 0x94, 0x49, 0xfd, 0x49, 0x80, 0x00, 0x40, 0xa0, 0x80, 0x40, 0x70, 0xc8, 0x24, 0x24, 0x04, 0x88, 0x70]),
        'owncloud': createIcon(3, [0x00, 0x01, 0x02, 0x03, 0x06, 0x0c, 0x1a, 0x13, 0x11, 0x19, 0x0f, 0x78, 0xcc, 0x87, 0xfc, 0x42, 0x81, 0x81, 0x81, 0x81, 0x43, 0xbd, 0x00, 0x00, 0x00, 0x80, 0x80, 0xe0, 0x30, 0x10, 0x28, 0x28, 0xd0]),
        'octocat': createIcon(1, [0x00, 0x3c, 0x42, 0x99, 0xa5, 0xa5, 0x99, 0x42, 0x3c, 0x00, 0x00]),
        'smile': createIcon(1, [0x00, 0x3c, 0x42, 0xa5, 0xa5, 0xa5, 0x99, 0x42, 0x3c, 0x00, 0x00]),
        'star': createIcon(1, [0x00, 0x10, 0x38, 0x7c, 0x38, 0x10, 0x7c, 0x38, 0x10, 0x00, 0x00]),
        'sun': createIcon(1, [0x00, 0x10, 0x38, 0x54, 0x38, 0x10, 0x38, 0x54, 0x38, 0x10, 0x00])
    };
    
    function parseText(text) {
        const result = [];
        let i = 0;
        while (i < text.length) {
            if (text[i] === ':') {
                const endIdx = text.indexOf(':', i + 1);
                if (endIdx !== -1) {
                    const iconName = text.substring(i + 1, endIdx).toLowerCase();
                    if (LED_ICONS[iconName]) {
                        result.push({ type: 'icon', name: iconName, data: LED_ICONS[iconName] });
                        i = endIdx + 1;
                        continue;
                    }
                }
            }
            const char = text[i];
            const bitmap = LED_FONTS[char] || LED_FONTS[' '];
            result.push({ type: 'char', char: char, data: bitmap });
            i++;
        }
        return result;
    }
    
    function bitmapToMatrix(bitmap) {
        const matrix = [];
        for (let row = 0; row < 8; row++) {
            const rowData = [];
            for (let col = 0; col < 7; col++) {
                if (col < bitmap.length) {
                    rowData.push((bitmap[col] >> row) & 1);
                }
            }
            matrix.push(rowData);
        }
        return matrix;
    }
    
    function renderLED(parsedText) {
        const ledMatrix = document.getElementById('ledMatrix');
        ledMatrix.innerHTML = '';
        
        const fullMatrix = [];
        for (let row = 0; row < 11; row++) { fullMatrix[row] = []; }
        
        parsedText.forEach((item, idx) => {
            let matrix;
            if (item.type === 'icon') {
                // DATA IS ALREADY 11 ROWS - USE AS IS
                matrix = item.data; 
            } else {
                // Pad Chars to 11 rows (Keep this for text)
                const charMatrix = bitmapToMatrix(item.data);
                matrix = [
                    new Array(7).fill(0), 
                    new Array(7).fill(0), 
                    ...charMatrix, 
                    new Array(7).fill(0)
                ];
            }
            
            for (let row = 0; row < 11; row++) {
                if (matrix[row]) {
                    fullMatrix[row].push(...matrix[row]);
                } else {
                    const width = (item.type === 'icon') ? item.data[0].length : 7;
                    fullMatrix[row].push(...new Array(width).fill(0));
                }
                // Spacing
                if (idx < parsedText.length - 1) fullMatrix[row].push(0, 0);
            }
        });
        
        // Render
        fullMatrix.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'led-row';
            row.forEach(pixel => {
                const pixelDiv = document.createElement('div');
                pixelDiv.className = 'led-pixel' + (pixel ? ' on' : '');
                rowDiv.appendChild(pixelDiv);
            });
            ledMatrix.appendChild(rowDiv);
        });

        // 3. APPLY SCROLLING LOGIC
        // We calculate speed based on content width. 
        // 50 pixels per second is a good comfortable read speed.
        const totalColumns = fullMatrix[0].length;
        const duration = Math.max(5, totalColumns / 25); // Minimum 5 seconds
        
        ledMatrix.style.animation = 'none';
        ledMatrix.offsetHeight; /* Trigger reflow */
        // Animation: name duration timing-function delay iteration-count
        ledMatrix.style.animation = \`marquee \${duration}s linear infinite\`;
        
        // Wait 1s before starting first scroll
        ledMatrix.style.animationDelay = '1s';
    }
    
    pm.getData(function(err, data) {
        if (err) return console.error(err);
        const displayText = data.displayText || 'NO DATA';
        document.getElementById('txt-display').innerText = displayText;
        const parsedText = parseText(displayText);
        renderLED(parsedText);
    });
</script>
`;

module.exports = {
    template: template
};